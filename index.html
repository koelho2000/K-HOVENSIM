<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-HOVENSIM v3.1 - Simulador de Efici√™ncia Energ√©tica de Fornos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #4CAF50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --text-color: #333;
            --bg-light: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER & SPLASH --- */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 20px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.5em; margin: 0; }
        .btn-home {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .btn-home:hover { background: rgba(255,255,255,0.4); }

        .splash-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            padding: 40px;
            background: var(--primary-gradient);
            color: white;
            text-align: center;
            min-height: 600px;
        }

        .btn-continue {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-top: 30px;
        }

        /* --- MENUS & NAVIGATION --- */
        .menu-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease-in-out;
        }
        .menu-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .menu-list {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .menu-list li {
            background: var(--bg-light);
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            border-left: 5px solid var(--primary-color);
            position: relative;
            transition: transform 0.2s;
        }
        .menu-list li:hover { transform: translateX(5px); background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-list li a { text-decoration: none; color: var(--text-color); font-weight: 600; display: flex; align-items: center; gap: 10px; }
        
        .status-badge {
            position: absolute; top: 15px; right: 15px;
            padding: 2px 8px; border-radius: 10px;
            font-size: 0.7em; color: white; font-weight: bold;
        }
        .status-complete { background: var(--accent-color); }
        .status-incomplete { background: var(--danger-color); }
        .status-pending { background: #999; }

        /* --- FORMS & INPUTS --- */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .form-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
        .form-group { margin-bottom: 15px; position: relative; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        
        input, select, textarea {
            width: 100%; padding: 10px;
            border: 1px solid #ddd; border-radius: 6px;
            font-size: 1em;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; }
        input[readonly] { background-color: #f0f0f0; color: #666; }

        .unit-display {
            font-size: 0.85em; color: #666; margin-top: 4px;
            display: flex; justify-content: space-between;
        }
        .unit-value { font-weight: bold; color: var(--primary-color); }

        /* --- BUTTONS --- */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn { padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-danger { background: var(--danger-color); color: white; }

        /* --- TOOLTIPS --- */
        .help-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px;
            background: #999; color: white;
            border-radius: 50%; font-size: 0.75em;
            margin-left: 8px; cursor: help;
            position: relative;
        }
        .help-icon:hover { background: var(--primary-color); }
        .help-icon::after {
            content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px; border-radius: 6px;
            font-size: 0.85em; font-weight: normal; width: 300px; z-index: 1000;
            display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); white-space: pre-wrap; text-align: left; line-height: 1.4;
        }
        .help-icon::before {
            content: ""; position: absolute; bottom: 115%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; display: none; z-index: 1000;
        }
        .help-icon:hover::after, .help-icon:hover::before { display: block; }

        /* --- CHARTS & TABLES --- */
        .chart-container { position: relative; width: 100%; height: 300px; margin: 20px 0; }
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; color: #666; }
        .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .summary-card { background: white; padding: 15px; border: 1px solid #eee; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .summary-card .value { font-size: 1.5em; font-weight: bold; color: var(--primary-color); display: block; margin: 5px 0; }
        .summary-card .label { font-size: 0.85em; color: #666; text-transform: uppercase; }

        .simulation-box { background: #f8f9fa; border-left: 4px solid var(--primary-color); padding: 20px; margin-top: 20px; border-radius: 4px; }
        .impact-box { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; margin-top: 15px; border-radius: 6px; }
        .impact-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #c8e6c9; }
        .impact-item:last-child { border-bottom: none; margin-bottom: 0; }
        .impact-title { font-weight: bold; color: #2e7d32; }
        .impact-detail { font-size: 0.9em; color: #555; margin-left: 10px; }
        
        .fuel-info-card {
            background: white; border: 1px solid #eee; padding: 15px; border-radius: 8px;
            margin-bottom: 10px; border-left: 4px solid #ddd;
        }
        .fuel-info-title { font-weight: bold; color: #333; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .fuel-tag { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; color: white; }
        .tag-green { background: #4CAF50; }
        .tag-orange { background: #ff9800; }
        .tag-red { background: #f44336; }
        .tag-blue { background: #2196F3; }

        .hidden { display: none !important; }

        /* Budget Table Specific */
        .budget-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #ddd; }
        .budget-table th { background: #f0f2f5; padding: 12px; border: 1px solid #ddd; text-align: left; font-weight: 600; }
        .budget-table td { padding: 8px; border: 1px solid #ddd; }
        .budget-table input { border: none; background: transparent; width: 100%; }
        .budget-table tr:last-child { background: #f9f9f9; font-weight: bold; }
        .budget-table tr:last-child input { font-weight: bold; color: var(--primary-color); font-size: 1.1em; }

        .project-scope-box {
            background: white; border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .scope-section { margin-bottom: 15px; }
        .scope-section h4 { color: var(--primary-color); margin-bottom: 8px; font-size: 1em; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .scope-text { font-size: 0.95em; color: #555; line-height: 1.5; }

        .comp-table { width: 100%; font-size: 0.9em; border-collapse: collapse; margin-top: 15px; }
        .comp-table th { background: #eef; color: #333; text-align: center; padding: 10px; border: 1px solid #ddd; }
        .comp-table td { text-align: center; border: 1px solid #ddd; padding: 8px; }
        .comp-diff-pos { color: green; font-weight: bold; }
        .comp-diff-neg { color: red; font-weight: bold; }

        @media (max-width: 768px) {
            .form-row, .form-row.three-col { grid-template-columns: 1fr; }
            .menu-list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Splash Screen -->
        <div id="splashScreen" class="splash-screen">
            <h1>K-HOVENSIM v3.1</h1>
            <p>Simulador de Efici√™ncia Energ√©tica de Fornos</p>
            <p style="opacity: 0.8; font-size: 0.9em; margin-top: 10px;">Vers√£o atualizada: Perfil Corrigido, Simula√ß√£o Robusta e Or√ßamento Detalhado.</p>
            <button class="btn-continue" onclick="startApp()">Entrar</button>
        </div>

        <!-- Header Global -->
        <div id="appHeader" class="header hidden">
            <h1>K-HOVENSIM</h1>
            <button class="btn-home" onclick="showMenu()">üè† Menu Principal</button>
        </div>

        <!-- Menu Principal -->
        <div id="mainMenu" class="menu-content">
            <h2 class="section-title">Painel de Controlo</h2>
            <ul class="menu-list" id="menuList">
                <!-- Preenchido via JS -->
            </ul>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-danger" onclick="resetAllData()">Limpar Dados</button>
            </div>
        </div>

        <!-- Sec√ß√µes -->
        <div id="sections">
            
            <!-- 1. Dados Iniciais -->
            <div id="section-1" class="menu-content">
                <div class="section-title">1. Dados Iniciais</div>
                <form id="formClient">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cliente</label>
                            <input type="text" id="clientName" placeholder="Nome da Empresa">
                        </div>
                        <div class="form-group">
                            <label>Instala√ß√£o</label>
                            <input type="text" id="buildingName" placeholder="Nome da F√°brica">
                        </div>
                    </div>
                    <div class="nav-buttons">
                        <button type="button" class="btn btn-secondary" onclick="showMenu()">Menu</button>
                        <button type="button" class="btn btn-primary" onclick="saveAndNext(1)">Pr√≥ximo ‚ûù</button>
                    </div>
                </form>
            </div>

            <!-- 2. Indicadores Energ√©ticos -->
            <div id="section-2" class="menu-content">
                <div class="section-title">2. Indicadores Energ√©ticos (2025)</div>
                
                <div class="tabs">
                    <button class="tab-button active" onclick="switchInfoTab('tab-prices')">Pre√ßos Atuais</button>
                    <button class="tab-button" onclick="switchInfoTab('tab-trends'); renderTrendChart()">Evolu√ß√£o & Futuro</button>
                    <button class="tab-button" onclick="switchInfoTab('tab-info')">Fichas T√©cnicas</button>
                </div>

                <div id="tab-prices" class="info-tab-content">
                    <div class="info-box" style="background:#e3f2fd; padding:15px; border-radius:5px; margin-bottom:20px;">
                        Preencha os custos unit√°rios. O sistema converte automaticamente para <strong>‚Ç¨/kWh</strong> usando o Poder Calor√≠fico (PCI) padr√£o.
                    </div>

                    <div class="form-row three-col">
                        <div class="form-group">
                            <label>Eletricidade (‚Ç¨/kWh)</label>
                            <input type="number" id="priceElec" value="0.1340" step="0.0001" onchange="updateEnergyEquivalents()">
                            <div class="unit-display">PCI: 1.0 kWh/kWh <span class="unit-value" id="eq-elec">‚Ç¨0.134/kWh</span></div>
                        </div>
                        <div class="form-group">
                            <label>G√°s Natural (‚Ç¨/kWh)</label>
                            <input type="number" id="priceGas" value="0.0598" step="0.0001" onchange="updateEnergyEquivalents()">
                            <div class="unit-display">PCI: ~10.7 kWh/m¬≥ <span class="unit-value" id="eq-gas">‚Ç¨0.060/kWh</span></div>
                        </div>
                        <div class="form-group">
                            <label>Biometano (‚Ç¨/kWh)</label>
                            <input type="number" id="priceBio" value="0.0650" step="0.0001" onchange="updateEnergyEquivalents()">
                            <div class="unit-display">PCI: ~10.0 kWh/m¬≥ <span class="unit-value" id="eq-bio">‚Ç¨0.065/kWh</span></div>
                        </div>
                    </div>
                    
                    <div class="form-row three-col">
                         <div class="form-group">
                            <label>GLP (‚Ç¨/kg)</label>
                            <input type="number" id="priceLPG" value="1.1500" step="0.0001" onchange="updateEnergyEquivalents()">
                            <div class="unit-display">PCI: 12.8 kWh/kg <span class="unit-value" id="eq-lpg">‚Ç¨0.090/kWh</span></div>
                        </div>
                        <div class="form-group">
                            <label>√ìleo Combust√≠vel (‚Ç¨/kg)</label>
                            <input type="number" id="priceOil" value="0.9500" step="0.0001" onchange="updateEnergyEquivalents()">
                            <div class="unit-display">PCI: 11.6 kWh/kg <span class="unit-value" id="eq-oil">‚Ç¨0.082/kWh</span></div>
                        </div>
                         <div class="form-group">
                            <label>Hidrog√©nio Verde (‚Ç¨/kg)</label>
                            <input type="number" id="priceH2" value="6.0000" step="0.0001" onchange="updateEnergyEquivalents()">
                            <div class="unit-display">PCI: 33.3 kWh/kg <span class="unit-value" id="eq-h2">‚Ç¨0.180/kWh</span></div>
                        </div>
                    </div>
                </div>

                <div id="tab-trends" class="info-tab-content hidden">
                    <div class="chart-container">
                        <canvas id="chartTrends"></canvas>
                    </div>
                    <div style="font-size:0.9em; color:#666; margin-top:10px; text-align:center;">
                        * Proje√ß√µes baseadas em tend√™ncias de mercado EU 2025 (Volatilidade do G√°s vs Eletrifica√ß√£o).
                    </div>
                </div>

                <div id="tab-info" class="info-tab-content hidden">
                    <div class="fuel-info-card" style="border-left-color: #4CAF50;">
                        <div class="fuel-info-title">Eletricidade <span class="fuel-tag tag-green">Alta Efici√™ncia</span></div>
                        <p style="font-size:0.9em; margin:0;"><strong>Efici√™ncia:</strong> 100% no ponto de uso.<br>
                        <strong>Impacto:</strong> Zero emiss√µes locais. Pegada depende do mix da rede.<br>
                        <strong>Futuro:</strong> Tend√™ncia de eletrifica√ß√£o total da ind√∫stria leve/m√©dia.</p>
                    </div>
                    <div class="fuel-info-card" style="border-left-color: #ff9800;">
                        <div class="fuel-info-title">G√°s Natural <span class="fuel-tag tag-orange">Transi√ß√£o</span></div>
                        <p style="font-size:0.9em; margin:0;"><strong>Efici√™ncia:</strong> M√©dia/Alta (com recupera√ß√£o). PCI ~10.7 kWh/m¬≥.<br>
                        <strong>Impacto:</strong> Combust√≠vel f√≥ssil mais limpo, mas emite CO2.<br>
                        <strong>Futuro:</strong> Aumento de custos devido a taxas de carbono (ETS).</p>
                    </div>
                    <div class="fuel-info-card" style="border-left-color: #2196F3;">
                        <div class="fuel-info-title">Biometano <span class="fuel-tag tag-green">Renov√°vel</span></div>
                        <p style="font-size:0.9em; margin:0;"><strong>Efici√™ncia:</strong> Id√™ntica ao G√°s Natural.<br>
                        <strong>Impacto:</strong> Neutro em carbono (Economia Circular).<br>
                        <strong>Futuro:</strong> Solu√ß√£o "Drop-in" imediata para descarboniza√ß√£o.</p>
                    </div>
                    <div class="fuel-info-card" style="border-left-color: #2196F3;">
                        <div class="fuel-info-title">Hidrog√©nio (H2) <span class="fuel-tag tag-blue">Futuro</span></div>
                        <p style="font-size:0.9em; margin:0;"><strong>Efici√™ncia:</strong> Queima a alta temperatura. PCI 33.3 kWh/kg.<br>
                        <strong>Impacto:</strong> Zero emiss√µes (apenas vapor de √°gua).<br>
                        <strong>Futuro:</strong> Solu√ß√£o para alta temperatura onde a eletrifica√ß√£o √© dif√≠cil.</p>
                    </div>
                    <div class="fuel-info-card" style="border-left-color: #f44336;">
                        <div class="fuel-info-title">√ìleo/GLP <span class="fuel-tag tag-red">F√≥ssil</span></div>
                        <p style="font-size:0.9em; margin:0;"><strong>Efici√™ncia:</strong> M√©dia. Mais poluentes que o g√°s.<br>
                        <strong>Impacto:</strong> Altas emiss√µes de CO2, SOx e NOx.<br>
                        <strong>Futuro:</strong> "Phase-out" progressivo.</p>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button type="button" class="btn btn-secondary" onclick="goToSection(1)">‚Üê Anterior</button>
                    <button type="button" class="btn btn-secondary" onclick="showMenu()">Menu</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndNext(2)">Pr√≥ximo ‚ûù</button>
                </div>
            </div>

            <!-- 3. Perfil de Carga -->
            <div id="section-3" class="menu-content">
                <div class="section-title">3. Perfil de Carga</div>
                <div class="tabs">
                    <button class="tab-button active" onclick="switchTab('tab-manual')">Definir Manualmente</button>
                    <button class="tab-button" onclick="switchTab('tab-import')">Importar CSV</button>
                </div>
                <div id="tab-manual" class="tab-content active">
                    <div class="form-row three-col">
                        <div class="form-group"><label>Padr√£o Di√°rio</label><select id="patternDaily"><option value="flat">Cont√≠nuo</option><option value="1shift">1 Turno (08-17h)</option><option value="2shifts">2 Turnos (06-22h)</option></select></div>
                        <div class="form-group"><label>Padr√£o Semanal</label><select id="patternWeekly"><option value="7days">7 Dias</option><option value="5days">5 Dias</option><option value="6days">6 Dias</option></select></div>
                        <div class="form-group"><label>Padr√£o Anual</label><select id="patternAnnual"><option value="constant">Constante</option><option value="august_stop">Paragem Agosto</option></select></div>
                    </div>
                    <div class="form-row three-col">
                        <div class="form-group"><label>Carga Base (kW)</label><input type="number" id="dailyMin" value="20"></div>
                        <div class="form-group"><label>Carga M√°x (kW)</label><input type="number" id="dailyMax" value="150"></div>
                        <div class="form-group"><label>Aleatoriedade (%)</label><input type="number" id="randomness" value="10"></div>
                    </div>
                    <button class="btn btn-primary" onclick="generateLoadProfile()">Gerar Perfil Anual</button>
                </div>
                <div id="tab-import" class="tab-content">
                    <input type="file" id="fileLoadProfile" accept=".csv,.txt">
                    <button type="button" class="btn btn-primary" onclick="importLoadProfile()" style="margin-top:10px;">Processar</button>
                </div>
                <div id="loadProfileResults" class="hidden">
                    <h3 style="margin-top:30px; color:var(--primary-color);">An√°lise do Perfil</h3>
                    <div class="tabs">
                        <button class="tab-button active" onclick="switchResultTab('res-daily')">Di√°rio</button>
                        <button class="tab-button" onclick="switchResultTab('res-weekly')">Semanal</button>
                        <button class="tab-button" onclick="switchResultTab('res-monthly')">Mensal</button>
                        <button class="tab-button" onclick="switchResultTab('res-hist')">Histograma</button>
                        <button class="tab-button" onclick="switchResultTab('res-summary')">Resumo</button>
                            <button class="tab-button" onclick="switchResultTab('res-hourly')">Anual Hor√°rio</button>
                    </div>
                    <div id="res-daily" class="res-tab-content active"><div class="chart-container"><canvas id="chartDay"></canvas></div></div>
                    <div id="res-weekly" class="res-tab-content hidden"><div class="chart-container"><canvas id="chartWeek"></canvas></div></div>
                    <div id="res-monthly" class="res-tab-content hidden"><div class="chart-container"><canvas id="chartYear"></canvas></div></div>
                    <div id="res-hist" class="res-tab-content hidden"><div class="chart-container"><canvas id="chartHist"></canvas></div></div>
                    <div id="res-summary" class="res-tab-content hidden">
                        <div class="table-responsive"><table><thead><tr><th>M√©trica</th><th>Valor</th></tr></thead><tbody id="summaryTable"></tbody></table></div>
                    </div>
                        <div id="res-hourly" class="res-tab-content hidden"><div class="chart-container"><canvas id="chartHourly"></canvas></div>
                            <div style="text-align:right; margin-top:10px;"><button class="btn btn-secondary" onclick="exportLoadProfileCSV()">‚¨áÔ∏è Exportar CSV</button></div>
                        </div>
                </div>
                <div class="nav-buttons">
                    <button type="button" class="btn btn-secondary" onclick="goToSection(2)">‚Üê Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndNext(3)">Pr√≥ximo ‚ûù</button>
                </div>
            </div>

            <!-- 4. Forno Atual -->
            <div id="section-4" class="menu-content">
                <div class="section-title">4. Defini√ß√£o do Forno Atual</div>
                <div class="form-row three-col">
                    <div class="form-group">
                        <label>Tipo de Forno <span class="help-icon" data-tooltip="Impacto no Processo:
‚Ä¢ C√¢mara/Po√ßo: Opera√ß√£o por lotes. Baixo Investimento inicial, mas menor efici√™ncia energ√©tica devido aos ciclos. Instala√ß√£o simples.
‚Ä¢ T√∫nel/Empurrador: Opera√ß√£o cont√≠nua. Alto Investimento, mas Alta Efici√™ncia para grandes volumes. Instala√ß√£o complexa.
‚Ä¢ Rotativo: Espec√≠fico para materiais granulares.">?</span></label>
                        <select id="furnaceType">
                            <option value="chamber">C√¢mara</option>
                            <option value="tunnel">T√∫nel</option>
                            <option value="rotary">Rotativo</option>
                            <option value="pusher">Empurrador</option>
                            <option value="pit">Po√ßo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Queimador <span class="help-icon" data-tooltip="Tecnologia Atual:
‚Ä¢ Atmosf√©rico: Muito simples, Baixo custo, Baixa Efici√™ncia (mistura ar/g√°s pobre).
‚Ä¢ Ar For√ßado: Padr√£o industrial. Efici√™ncia m√©dia, investimento moderado.
‚Ä¢ Alta Velocidade: Melhora a uniformidade da temperatura via convec√ß√£o.
‚Ä¢ Recuperativo: Sistema avan√ßado? Alta efici√™ncia.">?</span></label>
                        <select id="burnerType">
                            <option value="atmospheric">Atmosf√©rico (Baixa Efic.)</option>
                            <option value="forced-air">Ar For√ßado</option>
                            <option value="flat-flame">Chama Plana</option>
                            <option value="high-velocity">Alta Velocidade</option>
                            <option value="preheated">Pr√©-aquecido</option>
                            <option value="recuperative">Recuperativo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Combust√≠vel <span class="help-icon" data-tooltip="Vetor Energ√©tico:
‚Ä¢ G√°s Natural: Standard industrial. Bom balan√ßo custo/efici√™ncia.
‚Ä¢ √ìleo/Carv√£o: Baixa efici√™ncia de combust√£o, alta manuten√ß√£o.
‚Ä¢ El√©trico: 100% Eficiente no uso, custo energia mais alto.">?</span></label>
                        <select id="fuelType" onchange="updatePCI('current')">
                            <option value="natural-gas">G√°s Natural</option>
                            <option value="lpg">GLP (Propano)</option>
                            <option value="oil">√ìleo Combust√≠vel</option>
                            <option value="electric">Eletricidade</option>
                            <option value="coal">Carv√£o</option>
                        </select>
                    </div>
                </div>
                <h3 style="font-size:1.1em; color:var(--secondary-color);">Geometria & Opera√ß√£o</h3>
                <div class="form-row three-col">
                    <div class="form-group"><label>Comp. (m)</label><input type="number" id="dimLength" value="5"></div>
                    <div class="form-group"><label>Larg. (m)</label><input type="number" id="dimWidth" value="2"></div>
                    <div class="form-group"><label>Alt. (m)</label><input type="number" id="dimHeight" value="2"></div>
                </div>
                <div class="form-row three-col">
                    <div class="form-group"><label>Temp. Op. (¬∞C)</label><input type="number" id="operatingTemp" value="1000"></div>
                    <div class="form-group"><label>Excesso Ar (%)</label><input type="number" id="excessAir" value="20"></div>
                    <div class="form-group"><label>PCI</label><input type="number" id="calorificValue" value="38.5"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Isolamento</label>
                        <select id="insulationMaterial">
                            <option value="refractory-brick">Tijolo Refrat√°rio</option>
                            <option value="ceramic-fiber">Fibra Cer√¢mica</option>
                            <option value="mineral-wool">L√£ Mineral</option>
                            <option value="glass-wool">L√£ de Vidro</option>
                            <option value="refractory-foam">Espuma Refrat√°ria</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Espessura (mm)</label><input type="number" id="insulationThickness" value="200"></div>
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="calculateFurnace('current')">üîÑ Simular Performance Atual</button>
                
                <div id="res-current-box" class="simulation-box hidden">
                    <div class="summary-grid">
                        <div class="summary-card"><div class="label">Consumo</div><div class="value" id="res-curr-cons">0</div><small>unid/h</small></div>
                        <div class="summary-card"><div class="label">Efici√™ncia Global</div><div class="value" id="res-curr-eff">0</div><small>%</small></div>
                        <div class="summary-card"><div class="label">Pot√™ncia √ötil (M√©dia)</div><div class="value" id="res-curr-avg-pow">0</div><small>kW</small></div>
                        <div class="summary-card"><div class="label">Perdas Parede</div><div class="value" id="res-curr-wall">0</div><small>kW</small></div>
                        <div class="summary-card"><div class="label">Perdas Exaust√£o</div><div class="value" id="res-curr-flue">0</div><small>%</small></div>
                    </div>
                </div>

                <!-- Texto descritivo do forno atual -->
                <div id="desc-current" class="hidden" style="margin-top:15px; font-size:0.9em; background:#f5f5f5; padding:10px; border-radius:5px; line-height:1.4;"></div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToSection(3)">‚Üê Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndNext(4)">Pr√≥ximo ‚ûù</button>
                </div>
            </div>

            <!-- 5. Forno Proposto -->
            <div id="section-5" class="menu-content">
                <div class="section-title">5. Defini√ß√£o do Forno Proposto</div>
                <button class="btn btn-secondary" onclick="copyCurrentToProposed()" style="margin-bottom:20px;">üì• Copiar do Atual</button>
                
                <div class="form-row three-col">
                    <div class="form-group">
                        <label>Tipo de Forno <span class="help-icon" data-tooltip="Decis√£o de Investimento:
‚Ä¢ Manter Atual: Investimento Nulo.
‚Ä¢ C√¢mara -> T√∫nel: Investimento Muito Alto. Complexidade Alta (Layout). Efici√™ncia Muito Alta (+30-50%) para produ√ß√£o cont√≠nua.
‚Ä¢ Mudar tipo requer an√°lise de ROI a longo prazo.">?</span></label>
                        <select id="prop_furnaceType" onchange="updateImpactAnalysis()">
                            <option value="chamber">C√¢mara</option>
                            <option value="tunnel">T√∫nel</option>
                            <option value="rotary">Rotativo</option>
                            <option value="pusher">Empurrador</option>
                            <option value="pit">Po√ßo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Queimador <span class="help-icon" data-tooltip="Upgrade Tecnol√≥gico:
‚Ä¢ Ar For√ßado: Investimento Baixo. Instala√ß√£o Simples. Melhoria ~5-10%.
‚Ä¢ Alta Velocidade: Investimento M√©dio. Melhor uniformidade.
‚Ä¢ Recuperativo: Investimento Alto. Instala√ß√£o Complexa. Efici√™ncia Elevada (+20-30%).
‚Ä¢ Oxicombust√£o: Investimento Alto. Instala√ß√£o Complexa (O2). Efici√™ncia M√°xima.">?</span></label>
                        <select id="prop_burnerType" onchange="updateImpactAnalysis()">
                            <option value="recuperative">Recuperativo</option>
                            <option value="forced-air">Ar For√ßado</option>
                            <option value="atmospheric">Atmosf√©rico</option>
                            <option value="flat-flame">Chama Plana</option>
                            <option value="high-velocity">Alta Velocidade</option>
                            <option value="oxy-fuel">Oxicombust√£o</option>
                            <option value="preheated">Pr√©-aquecido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Combust√≠vel <span class="help-icon" data-tooltip="Transi√ß√£o Energ√©tica:
‚Ä¢ G√°s Natural: Manter (Inv. 0).
‚Ä¢ El√©trico: Investimento Alto (quadro/resist√™ncias). 100% Efic.
‚Ä¢ Hidrog√©nio: Inv. Muito Alto. Zero Carbono.
‚Ä¢ Biometano: Inv. Nulo (Drop-in). Neutro em Carbono.">?</span></label>
                        <select id="prop_fuelType" onchange="updatePCI('proposed'); updateImpactAnalysis()">
                            <option value="natural-gas">G√°s Natural</option>
                            <option value="biomethane">Biometano</option>
                            <option value="lpg">GLP</option>
                            <option value="oil">√ìleo Combust√≠vel</option>
                            <option value="electric">Electricidade</option>
                            <option value="hydrogen">Hidrog√©nio</option>
                            <option value="coal">Carv√£o</option>
                        </select>
                    </div>
                </div>
                <div class="form-row three-col">
                    <div class="form-group"><label>Comp. (m)</label><input type="number" id="prop_dimLength" onchange="updateImpactAnalysis()"></div>
                    <div class="form-group"><label>Larg. (m)</label><input type="number" id="prop_dimWidth" onchange="updateImpactAnalysis()"></div>
                    <div class="form-group"><label>Alt. (m)</label><input type="number" id="prop_dimHeight" onchange="updateImpactAnalysis()"></div>
                </div>
                <div class="form-row three-col">
                    <div class="form-group">
                        <label>Temp. Op. (¬∞C) <span class="help-icon" data-tooltip="Otimiza√ß√£o Processo:
‚Ä¢ Reduzir Temp: Investimento Zero. Complexidade Nula.
‚Ä¢ Efici√™ncia: Aumenta exponencialmente (menos perdas).
‚Ä¢ Validar qualidade do produto.">?</span></label>
                        <input type="number" id="prop_operatingTemp" onchange="updateImpactAnalysis()">
                    </div>
                    <div class="form-group">
                        <label>Excesso Ar (%) <span class="help-icon" data-tooltip="Afina√ß√£o Combust√£o:
‚Ä¢ Reduzir Excesso: Investimento Baixo (Sonda O2/V√°lvulas).
‚Ä¢ Efici√™ncia: Ganho imediato de 5-15% reduzindo ar aquecido desnecessariamente.">?</span></label>
                        <input type="number" id="prop_excessAir" onchange="updateImpactAnalysis()">
                    </div>
                    <div class="form-group"><label>PCI</label><input type="number" id="prop_calorificValue"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Isolamento <span class="help-icon" data-tooltip="Melhoria Envelope:
‚Ä¢ Fibra Cer√¢mica: Inv. M√©dio. Instala√ß√£o R√°pida. √ìtimo para ciclos r√°pidos.
‚Ä¢ Microporoso: Inv. Alto. Efici√™ncia M√°xima (menor condutividade).
‚Ä¢ Refor√ßo: Aplicar nova camada (Inv. Baixo/M√©dio).">?</span></label>
                        <select id="prop_insulationMaterial" onchange="updateImpactAnalysis()">
                            <option value="ceramic-fiber">Fibra Cer√¢mica</option>
                            <option value="mineral-wool">L√£ Mineral</option>
                            <option value="glass-wool">L√£ de Vidro</option>
                            <option value="refractory-brick">Tijolo Refrat√°rio</option>
                            <option value="refractory-foam">Espuma Refrat√°ria</option>
                            <option value="microporous">Microporoso</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Espessura (mm)</label><input type="number" id="prop_insulationThickness" onchange="updateImpactAnalysis()"></div>
                </div>
                
                <div id="impact-analysis-log" class="hidden" style="margin-bottom: 20px;"><div id="impact-list"></div></div>
                
                <button class="btn btn-primary" style="width:100%" onclick="calculateFurnace('proposed')">üîÑ Simular Performance Proposta</button>
                
                <div id="res-prop-box" class="simulation-box hidden" style="border-color: #4CAF50;">
                    <h4>Resultados (Forno Proposto)</h4>
                    <div class="summary-grid">
                        <div class="summary-card"><div class="label">Consumo M√©dio</div><div class="value" id="res-prop-cons">0</div><small>unid/h</small></div>
                        <div class="summary-card"><div class="label">Efici√™ncia Global</div><div class="value" id="res-prop-eff">0</div><small>%</small></div>
                        <div class="summary-card"><div class="label">Perdas Parede</div><div class="value" id="res-prop-wall">0</div><small>kW</small></div>
                        <div class="summary-card"><div class="label">Perdas Exaust√£o</div><div class="value" id="res-prop-flue">0</div><small>%</small></div>
                    </div>

                    <div id="prop-comparison-container" class="hidden" style="margin-top:20px; padding-top:15px; border-top:1px solid #ccc;">
                        <h5>Comparativo: Atual vs Proposto</h5>
                        <table class="comp-table">
                            <thead><tr><th>Indicador</th><th>Atual</th><th>Proposto</th><th>Diferen√ßa</th></tr></thead>
                            <tbody>
                                <tr><td>Efici√™ncia</td><td id="comp-curr-eff"></td><td id="comp-prop-eff"></td><td id="comp-diff-eff"></td></tr>
                                <tr><td>Consumo/h</td><td id="comp-curr-cons"></td><td id="comp-prop-cons"></td><td id="comp-diff-cons"></td></tr>
                                <tr><td>Perdas Parede</td><td id="comp-curr-wall"></td><td id="comp-prop-wall"></td><td id="comp-diff-wall"></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Texto descritivo do forno proposto -->
                <div id="desc-prop" class="hidden" style="margin-top:15px; font-size:0.9em; background:#f1f8e9; padding:10px; border-radius:5px; line-height:1.4;"></div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToSection(4)">‚Üê Anterior</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndNext(5)">Pr√≥ximo ‚ûù</button>
                </div>
            </div>

            <!-- 6. NOVO MENU: Or√ßamento Detalhado -->
            <div id="section-6" class="menu-content">
                <div class="section-title">6. Or√ßamento e Investimento Detalhado</div>
                
                <div class="form-row" style="align-items: center; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                    <div style="font-weight: bold;">Modo de C√°lculo:</div>
                    <label><input type="radio" name="budgetMode" value="auto" checked onchange="toggleBudgetMode()"> Autom√°tico (Estimativa K-HOVENSIM)</label>
                    <label><input type="radio" name="budgetMode" value="manual" onchange="toggleBudgetMode()"> Manual (Inser√ß√£o direta)</label>
                    <button class="btn btn-primary" style="margin-left: auto;" onclick="generateBudget()">Recalcular Or√ßamento</button>
                </div>

                <table class="budget-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Descri√ß√£o do Artigo</th>
                            <th style="width: 15%;">Quantidade</th>
                            <th style="width: 10%;">Unidade</th>
                            <th style="width: 15%;">Pre√ßo Unit. (‚Ç¨)</th>
                            <th style="width: 20%;">Total (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody id="budgetTableBody"></tbody>
                </table>

                <div id="project-scope-summary" class="project-scope-box hidden">
                    <div class="scope-section">
                        <h4>üìã Descri√ß√£o dos Trabalhos</h4>
                        <div id="scope-desc" class="scope-text"></div>
                    </div>
                    <div class="scope-section">
                        <h4>‚ö° Medidas de Efici√™ncia</h4>
                        <div id="scope-effic" class="scope-text"></div>
                    </div>
                    <div class="scope-section">
                        <h4>üîß Complexidade da Instala√ß√£o</h4>
                        <div id="scope-complex" class="scope-text"></div>
                    </div>
                    <div class="scope-section">
                        <h4>üìù Descri√ß√£o da Solu√ß√£o</h4>
                        <div id="scope-solution" class="scope-text"></div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToSection(5)">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="saveAndNext(6)">Confirmar Investimento ‚ûù</button>
                </div>
            </div>

            <!-- 7. Simula√ß√£o T√©cnica Comparativa (NOVO LAYOUT) -->
            <div id="section-7" class="menu-content">
                <div class="section-title">7. Simula√ß√£o T√©cnica Comparativa</div>
                <button class="btn btn-primary" style="width:100%; padding:15px; margin-bottom:20px;" onclick="runFullSimulation()">‚ñ∂Ô∏è Executar Simula√ß√£o</button>
                
                <div id="full-sim-results" class="hidden">
                    <div class="tabs">
                        <button class="tab-button active" onclick="switchCompTab('comp-daily')">Di√°rio</button>
                        <button class="tab-button" onclick="switchCompTab('comp-monthly')">Mensal</button>
                        <button class="tab-button" onclick="switchCompTab('comp-yearly')">Anual</button>
                        <button class="tab-button" onclick="switchCompTab('comp-table')">Tabela Resumo</button>
                    </div>

                    <div id="comp-daily" class="comp-tab-content active"><div class="chart-container"><canvas id="compChartDaily"></canvas></div></div>
                    <div id="comp-monthly" class="comp-tab-content hidden"><div class="chart-container"><canvas id="compChartMonthly"></canvas></div></div>
                    <div id="comp-yearly" class="comp-tab-content hidden"><div class="chart-container"><canvas id="compChartYearly"></canvas></div></div>
                    
                    <div id="comp-table" class="comp-tab-content hidden">
                        <div id="technicalTableContainer" style="margin-top:20px;"></div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToSection(6)">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="saveAndNext(7)">Ir para An√°lise Financeira</button>
                </div>
            </div>

            <!-- 8. An√°lise Financeira e ROI (MOVIDO) -->
            <div id="section-8" class="menu-content">
                <div class="section-title">8. An√°lise Financeira e ROI</div>
                <button class="btn btn-primary" onclick="generateFinancialTable()">Calcular Indicadores Financeiros</button>
                
                <div id="financial-results" class="hidden" style="margin-top: 20px;">
                    <div class="summary-grid">
                        <div class="summary-card"><div class="label">Poupan√ßa Anual</div><div class="value" id="fin-savings" style="color:green">‚Ç¨0</div></div>
                        <div class="summary-card"><div class="label">Investimento Total</div><div class="value" id="fin-capex">‚Ç¨0</div></div>
                        <div class="summary-card"><div class="label">Payback Simples</div><div class="value" id="fin-payback">0</div><small>anos</small></div>
                    </div>
                    
                    <h3 style="margin-top:30px; border-bottom: 1px solid #eee;">Tabela de Fluxo de Caixa (Cash Flow)</h3>
                    <div class="table-responsive" id="financialTableContainer8"></div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToSection(7)">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="saveAndNext(8)">Pr√≥ximo ‚ûù</button>
                </div>
            </div>

            <!-- 9. Relat√≥rio -->
            <div id="section-9" class="menu-content">
                 <div class="section-title">9. Relat√≥rio</div>
                 <div style="text-align:center; padding:40px;">
                     <p>Gere o relat√≥rio final com todos os dados calculados.</p>
                     <button class="btn btn-danger" onclick="generatePDFReport()">üìÑ Download PDF</button>
                 </div>
                 <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="goToSection(8)">‚Üê Anterior</button>
                    <button class="btn btn-secondary" onclick="showMenu()">Menu</button>
                </div>
            </div>

            <!-- 10. Import/Export -->
            <div id="section-10" class="menu-content">
                <div class="section-title">10. Importar / Exportar</div>
                <div class="form-row">
                    <div style="text-align:center;">
                        <button class="btn btn-primary" onclick="exportToJSON()">üíæ Download JSON</button>
                    </div>
                    <div style="text-align:center;">
                        <input type="file" id="fileImport" accept=".json" style="margin-bottom:10px;">
                        <button class="btn btn-secondary" onclick="importFromJSON()">Carregar Projeto</button>
                    </div>
                </div>
                <div class="nav-buttons">
                     <button type="button" class="btn btn-secondary" onclick="showMenu()">Menu Principal</button>
                </div>
            </div>
            
            <!-- 11. Comparar Projetos -->
            <div id="section-11" class="menu-content">
                <div class="section-title">11. Comparar Projetos</div>
                <input type="file" id="comparisonFiles" multiple accept=".json">
                <button class="btn btn-primary" onclick="prepareComparison()">Comparar</button>
                <div id="comparisonContainer"></div>
                <div class="nav-buttons">
                     <button type="button" class="btn btn-secondary" onclick="showMenu()">Menu Principal</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        let appData = {
            client: {},
            loadProfile: [],
            furnace: { perf: null, data: {} },
            proposed: { perf: null, data: {} },
            budget: { items: [], total: 0, manual: false },
            simResults: null
        };
        let charts = {};

        function startApp() {
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('appHeader').classList.remove('hidden');
            showMenu();
            if(appData.loadProfile.length === 0) generateLoadProfile(true);
            updateEnergyEquivalents();
        }

        function showMenu() {
            document.querySelectorAll('.menu-content').forEach(el => el.classList.remove('active'));
            document.getElementById('mainMenu').classList.add('active');
            updateMenuUI();
        }

        function goToSection(n) {
            document.querySelectorAll('.menu-content').forEach(el => el.classList.remove('active'));
            const sec = document.getElementById('section-' + n);
            if(sec) sec.classList.add('active');
            window.scrollTo(0,0);
            if(n === 6 && appData.budget.items.length === 0) generateBudget();
        }

        function saveAndNext(n) {
            if(n===1) {
                appData.client.name = document.getElementById('clientName').value;
                appData.client.building = document.getElementById('buildingName').value;
            }
            if(n===6) calculateBudgetTotal();
            goToSection(n+1);
        }

        function updateMenuUI() {
            const steps = [
                {id:1, t:"Dados Iniciais", s: appData.client.name ? 'complete':'incomplete'},
                {id:2, t:"Indicadores", s: 'complete'},
                {id:3, t:"Perfil Carga", s: appData.loadProfile.length>0 ? 'complete':'incomplete'},
                {id:4, t:"Forno Atual", s: appData.furnace.perf ? 'complete':'incomplete'},
                {id:5, t:"Forno Proposto", s: appData.proposed.perf ? 'complete':'incomplete'},
                {id:6, t:"Or√ßamento", s: appData.budget.total > 0 ? 'complete':'pending'},
                {id:7, t:"Simula√ß√£o T√©cnica", s: appData.furnace.perf && appData.proposed.perf ? 'complete':'pending'},
                {id:8, t:"An√°lise Financeira", s: 'pending'},
                {id:9, t:"Relat√≥rio", s: 'pending'},
                {id:10, t:"Exp/Imp", s: 'pending'},
                {id:11, t:"Comparar", s: 'pending'}
            ];
            const html = steps.map(x => `
                <li onclick="goToSection(${x.id})">
                    <a href="#">${x.t}</a>
                    <span class="status-badge status-${x.s}">${x.s==='complete'?'OK':'...'}</span>
                </li>
            `).join('');
            document.getElementById('menuList').innerHTML = html;
        }

        function resetAllData() { if(confirm("Apagar tudo?")) location.reload(); }

        // --- HELPER FUNCTIONS (Tabs, etc) ---
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(e=>e.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            event.target.classList.add('active');
        }
        function switchResultTab(tabId) {
            document.querySelectorAll('.res-tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#loadProfileResults .tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            event.target.classList.add('active');
        }
        function switchInfoTab(tabId) {
             document.querySelectorAll('.info-tab-content').forEach(el => el.classList.add('hidden'));
             document.querySelectorAll('#section-2 .tab-button').forEach(el => el.classList.remove('active'));
             document.getElementById(tabId).classList.remove('hidden');
             event.target.classList.add('active');
        }
        function switchCompTab(tabId) {
             document.querySelectorAll('.comp-tab-content').forEach(el => el.classList.add('hidden'));
             document.querySelectorAll('#section-7 .tab-button').forEach(el => el.classList.remove('active'));
             document.getElementById(tabId).classList.remove('hidden');
             event.target.classList.add('active');
        }

        // --- GENERATORS & CALCULATIONS ---
        function generateLoadProfile(silent=false) {
            const min = parseFloat(document.getElementById('dailyMin').value)||20;
            const max = parseFloat(document.getElementById('dailyMax').value)||150;
            const profile = [];
            
            // Daily Pattern
            const patD = document.getElementById('patternDaily').value;
            const patW = document.getElementById('patternWeekly').value;
            const patA = document.getElementById('patternAnnual').value;
            
            const start = new Date(2025,0,1);

            for(let i=0; i<8760; i++) {
                let date = new Date(start.getTime() + i*3600000);
                let h=date.getHours(), d=date.getDay(), m=date.getMonth();
                
                let fD=1.0, fW=1.0, fA=1.0;
                
                // Daily
                if(patD==='1shift') fD=(h>=8 && h<17)?1:0.1;
                else if(patD==='2shifts') fD=(h>=6 && h<22)?1:0.1;
                
                // Weekly
                if(patW==='5days' && (d===0||d===6)) fW=0.1;
                if(patW==='6days' && d===0) fW=0.1;
                
                // Annual
                if(patA==='august_stop' && m===7) fA=0;

                let val = min + (max-min)*fD*fW*fA;
                val += (Math.random()-0.5)*5; // Noise
                profile.push(Math.max(min,val));
            }
            appData.loadProfile = profile;

        // Calcular estat√≠sticas de carga para utiliza√ß√£o posterior (pot√™ncia m√©dia e m√°xima)
        // Guardar estat√≠sticas para compara√ß√£o: m√©dia simples e pico m√°ximo (kW)
        const sum = profile.reduce((a,b) => a + b, 0);
        const avgLoad = sum / profile.length;
        const maxLoad = Math.max(...profile);
        appData.loadStats = { avg: avgLoad, max: maxLoad };
            if(!silent) {
                renderAllCharts(profile);
                document.getElementById('loadProfileResults').classList.remove('hidden');
            }
        }
        
        function renderAllCharts(profile) {
             let hSums = new Array(24).fill(0);
             profile.forEach((v,i) => hSums[i%24] += v);
             let hAvg = hSums.map(v => v/365);
             createChart('chartDay', 'line', Array.from({length:24},(_,i)=>i+'h'), hAvg, 'M√©dia Di√°ria (kW)', '#667eea');

             // Weekly (Average Day)
             let wSums = new Array(7).fill(0);
             let wCounts = new Array(7).fill(0);
             let startDay = 3; // Jan 1 2025 was Wed (3)
             profile.forEach((v,i) => {
                 let day = (Math.floor(i/24) + startDay) % 7;
                 wSums[day] += v; wCounts[day]++;
             });
             let wAvg = wSums.map((v,i) => v/(wCounts[i]*24)); // Avg power per day
             createChart('chartWeek', 'bar', ['Dom','Seg','Ter','Qua','Qui','Sex','Sab'], wAvg, 'M√©dia Semanal (kW)', '#4CAF50');
 
             // Monthly (Total MWh)
             let mSums = new Array(12).fill(0);
             let hoursInMonth = [744, 672, 744, 720, 744, 720, 744, 744, 720, 744, 720, 744];
             let mIdx = 0, hCount = 0;
             profile.forEach(v => {
                 mSums[mIdx] += v;
                 hCount++;
                 if(hCount >= hoursInMonth[mIdx]) { hCount=0; mIdx++; if(mIdx>11) mIdx=11; }
             });
             let mMWh = mSums.map(v => v/1000);
             createChart('chartYear', 'bar', ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], mMWh, 'Consumo Mensal (MWh)', '#ff9800');
 
             // Histogram
             let min = Math.min(...profile), max = Math.max(...profile);
             let bins = 10, binSize = (max-min)/bins;
             let hist = new Array(bins).fill(0), labels = [];
             for(let i=0; i<bins; i++) labels.push((min + i*binSize).toFixed(0));
             profile.forEach(v => {
                 let idx = Math.floor((v-min)/binSize);
                 if(idx>=bins) idx=bins-1;
                 hist[idx]++;
             });
             createChart('chartHist', 'bar', labels, hist, 'Frequ√™ncia (Horas)', '#f44336');

             // Summary
             let totalMWh = profile.reduce((a,b)=>a+b,0)/1000;
             let avg = totalMWh*1000/8760;
             document.getElementById('summaryTable').innerHTML = `
                 <tr><td>Consumo Total</td><td>${totalMWh.toFixed(1)} MWh</td></tr>
                 <tr><td>Pot√™ncia M√©dia</td><td>${avg.toFixed(1)} kW</td></tr>
                 <tr><td>Pico M√°ximo</td><td>${max.toFixed(1)} kW</td></tr>
             `;

             // Gr√°fico anual hor√°rio (8760 horas)
             if(document.getElementById('chartHourly')) {
                 const hourLabels = Array.from({length:profile.length}, (_,i) => (i+1).toString());
                 createChart('chartHourly', 'line', hourLabels, profile, 'Perfil Hor√°rio (kW)', '#2196F3');
             }
        }

        // Exportar o perfil de carga anual para CSV (8760 horas)
        function exportLoadProfileCSV() {
            if(!appData.loadProfile || !appData.loadProfile.length) { alert('Gere ou importe primeiro o perfil de carga.'); return; }
            const start = new Date(2025,0,1);
            let csv = 'DataHora;kW\n';
            appData.loadProfile.forEach((val, idx) => {
                const date = new Date(start.getTime() + idx*3600000);
                const iso = date.getFullYear()+'-'+String(date.getMonth()+1).padStart(2,'0')+'-'+String(date.getDate()).padStart(2,'0')+' '+String(date.getHours()).padStart(2,'0')+':00';
                csv += iso + ';' + val.toFixed(2) + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'perfil_carga_8760h.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function createChart(id, type, labels, data, label, color, data2=null, label2=null, color2=null) {
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            
            let datasets = [{ label: label, data: data, backgroundColor: color+'88', borderColor: color, fill: !data2 }];
            if(data2) {
                 datasets.push({ label: label2, data: data2, backgroundColor: color2+'88', borderColor: color2, fill: false });
            }

            charts[id] = new Chart(ctx, {
                type: type, 
                data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateEnergyEquivalents() {
             const pElec = parseFloat(document.getElementById('priceElec').value);
             document.getElementById('eq-elec').innerText = '‚Ç¨'+pElec.toFixed(3)+'/kWh';
             
             // Gas: PCI 10.7 kWh/m3
             const pGas = parseFloat(document.getElementById('priceGas').value);
             document.getElementById('eq-gas').innerText = '‚Ç¨'+(pGas/10.7).toFixed(3)+'/kWh';
 
             // Bio: PCI 10.0 kWh/m3
             const pBio = parseFloat(document.getElementById('priceBio').value);
             document.getElementById('eq-bio').innerText = '‚Ç¨'+(pBio/10.0).toFixed(3)+'/kWh';
             
             // LPG: 12.8 kWh/kg
             const pLpg = parseFloat(document.getElementById('priceLPG').value);
             document.getElementById('eq-lpg').innerText = '‚Ç¨'+(pLpg/12.8).toFixed(3)+'/kWh';
 
             // Oil: 11.6 kWh/kg
             const pOil = parseFloat(document.getElementById('priceOil').value);
             document.getElementById('eq-oil').innerText = '‚Ç¨'+(pOil/11.6).toFixed(3)+'/kWh';
             
             // H2: 33.3 kWh/kg
             const pH2 = parseFloat(document.getElementById('priceH2').value);
             document.getElementById('eq-h2').innerText = '‚Ç¨'+(pH2/33.3).toFixed(3)+'/kWh';
        }
        
        function getFuelPricePerKWh(type) {
             if(type === 'natural-gas') return parseFloat(document.getElementById('priceGas').value);
             if(type === 'biomethane') return parseFloat(document.getElementById('priceBio').value);
             if(type === 'electric') return parseFloat(document.getElementById('priceElec').value);
             if(type === 'lpg') return parseFloat(document.getElementById('priceLPG').value) / 12.8;
             if(type === 'oil') return parseFloat(document.getElementById('priceOil').value) / 11.6;
             if(type === 'hydrogen') return parseFloat(document.getElementById('priceH2').value) / 33.3;
             return parseFloat(document.getElementById('priceGas').value);
        }

        function calculateFurnace(mode) {
             if(!appData.loadProfile.length) return alert("Perfil!");
             const prefix = mode==='proposed'?'prop_':'';
             const T_op = parseFloat(document.getElementById(prefix+'operatingTemp').value)||1000;
             const exAir = parseFloat(document.getElementById(prefix+'excessAir').value)||20;
             const pci = parseFloat(document.getElementById(prefix+'calorificValue').value)||38.5;
             const L = parseFloat(document.getElementById(prefix+'dimLength').value)||5;
             const W = parseFloat(document.getElementById(prefix+'dimWidth').value)||2;
             const H = parseFloat(document.getElementById(prefix+'dimHeight').value)||2;
             const insThick = parseFloat(document.getElementById(prefix+'insulationThickness').value)||200;
             const fuel = document.getElementById(prefix+'fuelType').value;
             const bType = document.getElementById(prefix+'burnerType').value;
             const fType = document.getElementById(prefix+'furnaceType').value;
 
             let procFactor = 1.0;
             if(['chamber','pit','pusher'].includes(fType)) procFactor = 1.3;
 
             const avgLoad = appData.loadProfile.reduce((a,b)=>a+b,0)/8760;
             const area = 2*(L*W + L*H + W*H);
             let k = document.getElementById(prefix+'insulationMaterial').value.includes('fiber') ? 0.1 : 0.2;
             const wallLoss = (area * k * (T_op - 20)) / (insThick/1000) / 1000;
 
             let flueLoss = 0;
             if(fuel !== 'electric') {
                 let T_gas = T_op + 100;
                 if(bType.includes('recuperative') || bType.includes('preheated')) T_gas = T_op * 0.6;
                 flueLoss = (0.045 * (T_gas-20)/10) * (1 + exAir/100);
                 if(flueLoss>60) flueLoss=60;
             }
 
             const totalInput = ((avgLoad + wallLoss) / (1 - flueLoss/100)) * procFactor;
             const efficiency = (avgLoad / totalInput) * 100;
             const consHour = (totalInput * 3.6) / pci;
 
             const res = { avgLoad, wallLoss, flueLoss, efficiency, consHour, totalInput };
             const dataObj = { 
                 furnaceType: fType,
                 burnerType: bType, fuelType: fuel, operatingTemp: T_op, excessAir: exAir,
                 insulationMaterial: document.getElementById(prefix+'insulationMaterial').value,
                 insulationThickness: insThick
             };
 
             if(mode === 'current') {
                 appData.furnace.perf = res;
                 appData.furnace.data = dataObj;
                 document.getElementById('res-current-box').classList.remove('hidden');
                 document.getElementById('res-curr-cons').innerText = consHour.toFixed(1);
                 document.getElementById('res-curr-eff').innerText = efficiency.toFixed(1);
                 document.getElementById('res-curr-wall').innerText = wallLoss.toFixed(1);
                 document.getElementById('res-curr-flue').innerText = flueLoss.toFixed(1);
                 document.getElementById('res-curr-avg-pow').innerText = avgLoad.toFixed(1);

                // Actualize descri√ß√£o do forno atual
                updateFurnaceDescription('current');
             } else {
                 appData.proposed.perf = res;
                 appData.proposed.data = dataObj;
                 document.getElementById('res-prop-box').classList.remove('hidden');
                 document.getElementById('res-prop-cons').innerText = consHour.toFixed(1);
                 document.getElementById('res-prop-eff').innerText = efficiency.toFixed(1);
                 document.getElementById('res-prop-wall').innerText = wallLoss.toFixed(1);
                 document.getElementById('res-prop-flue').innerText = flueLoss.toFixed(1);
                 updateImpactAnalysis();
                 
                 if(appData.furnace.perf) {
                     const c = appData.furnace.perf;
                     document.getElementById('comp-curr-eff').innerText = c.efficiency.toFixed(1)+'%';
                     document.getElementById('comp-prop-eff').innerText = efficiency.toFixed(1)+'%';
                     document.getElementById('comp-diff-eff').innerHTML = diffHTML(efficiency-c.efficiency, true);
                     
                     document.getElementById('comp-curr-cons').innerText = c.consHour.toFixed(1);
                     document.getElementById('comp-prop-cons').innerText = consHour.toFixed(1);
                     document.getElementById('comp-diff-cons').innerHTML = diffHTML(consHour-c.consHour, false);
                     
                     document.getElementById('comp-curr-wall').innerText = c.wallLoss.toFixed(1);
                     document.getElementById('comp-prop-wall').innerText = wallLoss.toFixed(1);
                     document.getElementById('comp-diff-wall').innerHTML = diffHTML(wallLoss-c.wallLoss, false);
                     
                     document.getElementById('prop-comparison-container').classList.remove('hidden');
                 }

                // Actualize descri√ß√£o do forno proposto
                updateFurnaceDescription('proposed');
             }
        }

        // Gerar descri√ß√£o textual para o forno atual/proposto com compara√ß√£o √† carga
        function updateFurnaceDescription(mode) {
            // Garantir que estat√≠sticas de carga existem
            if(!appData.loadStats) return;
            const avgProfile = appData.loadStats.avg || 0;
            const maxProfile = appData.loadStats.max || 0;
            const prefix = mode === 'proposed' ? 'prop_' : '';
            const fType = document.getElementById(prefix+'furnaceType')?.value || '';
            const bType = document.getElementById(prefix+'burnerType')?.value || '';
            const fuel = document.getElementById(prefix+'fuelType')?.value || '';
            const L = parseFloat(document.getElementById(prefix+'dimLength')?.value) || 0;
            const W = parseFloat(document.getElementById(prefix+'dimWidth')?.value) || 0;
            const H = parseFloat(document.getElementById(prefix+'dimHeight')?.value) || 0;
            const T = parseFloat(document.getElementById(prefix+'operatingTemp')?.value) || 0;
            const ex = parseFloat(document.getElementById(prefix+'excessAir')?.value) || 0;

            // Obter resultados de performance
            const perf = mode === 'proposed' ? appData.proposed.perf : appData.furnace.perf;
            if(!perf) return;
            const totalInput = perf.totalInput || 0;

            // Tabelas de nomes amig√°veis
            const furnaceNames = {
                'chamber': 'c√¢mara', 'pit': 'po√ßo', 'pusher': 'empurrador', 'tunnel': 't√∫nel', 'rotary': 'rotativo'
            };
            const burnerNames = {
                'atmospheric': 'atmosf√©rico',
                'forced-air': 'ar for√ßado',
                'flat-flame': 'chama plana',
                'high-velocity': 'alta velocidade',
                'preheated': 'pr√©‚Äëaquecido',
                'recuperative': 'recuperativo',
                'oxy-fuel': 'oxicombust√£o'
            };
            const fuelNames = {
                'natural-gas': 'g√°s natural',
                'biomethane': 'biometano',
                'lpg': 'GLP',
                'oil': '√≥leo combust√≠vel',
                'electric': 'eletricidade',
                'hydrogen': 'hidrog√©nio',
                'coal': 'carv√£o'
            };

            let obs = '';
            if(totalInput <= maxProfile) {
                obs = 'A pot√™ncia simulada est√° abaixo do pico m√°ximo do perfil de carga, garantindo capacidade suficiente.';
            } else if(totalInput <= maxProfile * 1.2) {
                obs = 'A pot√™ncia simulada aproxima‚Äëse do pico m√°ximo do perfil; recomenda‚Äëse avaliar a capacidade de fornecimento.';
            } else {
                obs = 'A pot√™ncia simulada excede o pico m√°ximo do perfil. Pode ser necess√°rio refor√ßar a pot√™ncia dispon√≠vel ou otimizar a opera√ß√£o.';
            }
            const txt = `<strong>Descri√ß√£o:</strong> Forno do tipo ${furnaceNames[fType] || fType}, com queimador ${burnerNames[bType] || bType} alimentado a ${fuelNames[fuel] || fuel}. As dimens√µes internas s√£o ${L}√ó${W}√ó${H}\u00a0m e a temperatura de opera√ß√£o √© ${T}\u00a0¬∞C com excesso de ar de ${ex}%. <br><strong>Avalia√ß√£o:</strong> A pot√™ncia simulada √© ${totalInput.toFixed(1)}\u00a0kW, enquanto a pot√™ncia m√©dia do perfil de carga √© ${avgProfile.toFixed(1)}\u00a0kW e o pico m√°ximo √© ${maxProfile.toFixed(1)}\u00a0kW. ${obs}`;
            const el = document.getElementById(mode === 'proposed' ? 'desc-prop' : 'desc-current');
            if(el) {
                el.innerHTML = txt;
                el.classList.remove('hidden');
            }
        }

        function diffHTML(val, positiveIsGood) {
            let col = 'black';
            if(positiveIsGood) col = val>=0 ? 'green' : 'red';
            else col = val<=0 ? 'green' : 'red';
            return `<span style="color:${col}; font-weight:bold">${val>0?'+':''}${val.toFixed(1)}</span>`;
        }

        function updateImpactAnalysis() { /* Logic from previous context assumed here */ 
             const div = document.getElementById('impact-analysis-log');
             div.innerHTML = '';
             const pT = document.getElementById('prop_furnaceType').value;
             const cT = document.getElementById('furnaceType').value;
             if(pT!==cT) div.innerHTML+=`<div class="impact-box"><div class="impact-title">Mudan√ßa Tipo Forno</div><div>Grande impacto efici√™ncia</div></div>`;
             div.classList.remove('hidden');
        }
        function copyCurrentToProposed() { /* Logic from previous context */ 
            ['furnaceType','burnerType','fuelType','dimLength','dimWidth','dimHeight','operatingTemp','excessAir','calorificValue','insulationThickness'].forEach(id=>{
                if(document.getElementById(id)) document.getElementById('prop_'+id).value = document.getElementById(id).value;
            });
            updateImpactAnalysis();
        }
        function generateBudget() {
            if(appData.budget.manual) {
                // No modo manual, o utilizador ir√° inserir os valores directamente; apenas recalculamos total
                calculateBudgetTotal();
            } else {
                renderBudgetTable();
            }
        }
        // Gera√ß√£o autom√°tica do or√ßamento detalhado com base no forno proposto
        function renderBudgetTable() {
            // Garantir que existem dados do forno proposto
            if(!appData.proposed || !appData.proposed.data || !appData.proposed.data.furnaceType) {
                alert('Defina e simule o forno proposto antes de gerar o or√ßamento.');
                return;
            }
            const data = appData.proposed.data;
            const perf = appData.proposed.perf || {};
            const items = [];

            // Forno principal ‚Äì custos aproximados em fun√ß√£o do tipo
            let furnaceCost = 0;
            let furnaceDesc = '';
            switch(data.furnaceType) {
                case 'chamber': furnaceCost = 50000; furnaceDesc = 'Forno de c√¢mara (opera√ß√£o por lotes)'; break;
                case 'tunnel': furnaceCost = 200000; furnaceDesc = 'Forno de t√∫nel (opera√ß√£o cont√≠nua)'; break;
                case 'rotary': furnaceCost = 120000; furnaceDesc = 'Forno rotativo para materiais granulares'; break;
                case 'pusher': furnaceCost = 180000; furnaceDesc = 'Forno empurrador de funcionamento cont√≠nuo'; break;
                case 'pit': furnaceCost = 80000; furnaceDesc = 'Forno do tipo po√ßo'; break;
                default: furnaceCost = 50000; furnaceDesc = 'Forno industrial';
            }
            items.push({ desc: furnaceDesc, qty: 1, unit: 'unid', unitPrice: furnaceCost, total: furnaceCost });

            // Queimador
            let burnerCost = 0;
            let burnerDesc = '';
            switch(data.burnerType) {
                case 'atmospheric': burnerCost = 5000; burnerDesc = 'Queimador atmosf√©rico'; break;
                case 'forced-air': burnerCost = 12000; burnerDesc = 'Queimador de ar for√ßado'; break;
                case 'flat-flame': burnerCost = 15000; burnerDesc = 'Queimador de chama plana'; break;
                case 'high-velocity': burnerCost = 20000; burnerDesc = 'Queimador de alta velocidade'; break;
                case 'preheated': burnerCost = 18000; burnerDesc = 'Queimador pr√©‚Äëaquecido'; break;
                case 'recuperative': burnerCost = 25000; burnerDesc = 'Queimador recuperativo com trocador'; break;
                case 'oxy-fuel': burnerCost = 30000; burnerDesc = 'Queimador de oxicombust√£o'; break;
                default: burnerCost = 12000; burnerDesc = 'Queimador industrial';
            }
            items.push({ desc: burnerDesc, qty: 1, unit: 'unid', unitPrice: burnerCost, total: burnerCost });

            // Alimenta√ß√£o e infraestrutura de combust√≠vel
            let supplyCost = 0;
            let supplyDesc = '';
            switch(data.fuelType) {
                case 'electric': supplyCost = 30000; supplyDesc = 'Adequa√ß√£o da instala√ß√£o el√©ctrica e resist√™ncias'; break;
                case 'hydrogen': supplyCost = 70000; supplyDesc = 'Rede e armazenamento de hidrog√©nio verde (incl. seguran√ßa)'; break;
                case 'biomethane': supplyCost = 10000; supplyDesc = 'Adapta√ß√£o de rede para biometano'; break;
                case 'lpg': supplyCost = 15000; supplyDesc = 'Instala√ß√£o de dep√≥sito e rede de GLP'; break;
                case 'oil': supplyCost = 12000; supplyDesc = 'Instala√ß√£o de tanque e linha de √≥leo combust√≠vel'; break;
                case 'coal': supplyCost = 8000; supplyDesc = 'Sistema de armazenamento e alimenta√ß√£o de carv√£o'; break;
                default: supplyCost = 8000; supplyDesc = 'Adequa√ß√£o de rede de g√°s natural';
            }
            items.push({ desc: supplyDesc, qty: 1, unit: 'unid', unitPrice: supplyCost, total: supplyCost });

            // Sistema de isolamento ‚Äì custo proporcional √† √°rea envolvente
            const L = parseFloat(data.dimLength) || 5;
            const W = parseFloat(data.dimWidth) || 2;
            const H = parseFloat(data.dimHeight) || 2;
            const area = 2 * (L * W + L * H + W * H);
            const insulationCostPerM2 = 150; // ‚Ç¨/m¬≤ ‚Äì fornecimento e aplica√ß√£o
            const insCost = area * insulationCostPerM2;
            items.push({ desc: 'Isolamento t√©rmico (materiais e aplica√ß√£o)', qty: area.toFixed(1), unit: 'm¬≤', unitPrice: insulationCostPerM2, total: insCost });

            // Sistema de controlo e instrumenta√ß√£o
            const controlCost = 10000;
            items.push({ desc: 'Sistema de controlo e automa√ß√£o (sensores, PLC, HMI)', qty: 1, unit: 'unid', unitPrice: controlCost, total: controlCost });

            // Chamin√© e exaust√£o
            const stackCost = 15000;
            items.push({ desc: 'Chamin√© / sistema de exaust√£o com ventilador', qty: 1, unit: 'unid', unitPrice: stackCost, total: stackCost });

            // Liga√ß√µes el√©ctricas e quadros
            const electricalCost = 8000;
            items.push({ desc: 'Quadro el√©ctrico e cablagem', qty: 1, unit: 'unid', unitPrice: electricalCost, total: electricalCost });

            // Obras civis e funda√ß√µes
            const civilCost = 12000;
            items.push({ desc: 'Funda√ß√µes e obras civis (base de suporte)', qty: 1, unit: 'unid', unitPrice: civilCost, total: civilCost });

            // Montagem, comissionamento e forma√ß√£o
            const installCost = 0.15 * (furnaceCost + burnerCost + supplyCost + insCost + controlCost + stackCost + electricalCost + civilCost);
            items.push({ desc: 'Montagem, comissionamento e forma√ß√£o', qty: 1, unit: 'unid', unitPrice: installCost, total: installCost });

            // Engenharia e projecto
            const engineeringCost = 8000;
            items.push({ desc: 'Projecto e engenharia', qty: 1, unit: 'unid', unitPrice: engineeringCost, total: engineeringCost });

            // Calcular total geral
            let total = 0;
            items.forEach(it => { total += it.total; });
            appData.budget.items = items;
            appData.budget.total = total;

            // Construir tabela HTML
            let html = '';
            items.forEach(it => {
                html += `<tr><td>${it.desc}</td><td>${it.qty}</td><td>${it.unit}</td><td>${it.unitPrice.toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0})}</td><td>${it.total.toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0})}</td></tr>`;
            });
            document.getElementById('budgetTableBody').innerHTML = html;

            // Mostrar resumo do √¢mbito do projecto
            document.getElementById('project-scope-summary').classList.remove('hidden');

            // Mapas de nomes de combust√≠vel para uso nas descri√ß√µes
            const fuelNamesMap = {
                'natural-gas': 'g√°s natural',
                'biomethane': 'biometano',
                'lpg': 'GLP',
                'oil': '√≥leo combust√≠vel',
                'electric': 'electricidade',
                'hydrogen': 'hidrog√©nio',
                'coal': 'carv√£o'
            };
            // Descri√ß√£o dos trabalhos
            let scopeDesc = `Substitui√ß√£o/instala√ß√£o de um novo forno ${furnaceDesc.toLowerCase()}, equipado com ${burnerDesc.toLowerCase()} e adaptado para funcionar a ${fuelNamesMap[data.fuelType] || data.fuelType}. As obras incluem a demoli√ß√£o/retirada do equipamento existente, execu√ß√£o de funda√ß√µes, montagem do forno, isolamento, instala√ß√£o da chamin√©, execu√ß√£o de redes de alimenta√ß√£o de combust√≠vel e energia el√©ctrica, bem como integra√ß√£o de sistemas de controlo e seguran√ßa.`;
            // Medidas de efici√™ncia
            let scopeEff = 'Melhorias de efici√™ncia incluem a utiliza√ß√£o de isolamento adequado, optimiza√ß√£o do excesso de ar, recupera√ß√£o de calor (quando aplic√°vel) e moderniza√ß√£o do queimador para maior rendimento.';
            // Complexidade
            let scopeComplex = 'A complexidade √© considerada m√©dia a alta devido √† necessidade de adequa√ß√£o de infra‚Äëestruturas e paragem prolongada de produ√ß√£o durante a montagem.';
            // Descri√ß√£o da solu√ß√£o
            let scopeSolution = 'A solu√ß√£o proposta visa reduzir o consumo espec√≠fico e as emiss√µes, aumentando a efici√™ncia do processo e permitindo flexibilidade para futuros vectores energ√©ticos.';
            document.getElementById('scope-desc').innerText = scopeDesc;
            document.getElementById('scope-effic').innerText = scopeEff;
            document.getElementById('scope-complex').innerText = scopeComplex;
            document.getElementById('scope-solution').innerText = scopeSolution;
        }
        function calculateBudgetTotal() {
            // Somar coluna Total da tabela quando em modo manual
            let total = 0;
            document.querySelectorAll('#budgetTableBody tr').forEach(row => {
                const val = row.children[4]?.innerText || '0';
                // remover separadores de milhar
                const num = parseFloat(val.toString().replace(/\./g,'').replace(/,/g,'.'));
                if(!isNaN(num)) total += num;
            });
            appData.budget.total = total;
        }
        function toggleBudgetMode() {
            const mode = document.querySelector('input[name="budgetMode"]:checked').value;
            appData.budget.manual = (mode === 'manual');
            if(!appData.budget.manual) {
                renderBudgetTable();
            }
        }
        function updateBudgetItem() {
            // Placeholder: nesta vers√£o n√£o √© necess√°rio pois o or√ßamento √© calculado automaticamente.
        }
        // Actualiza o valor do PCI (poder calor√≠fico inferior) consoante o combust√≠vel seleccionado
        function updatePCI(m) {
            const prefix = m === 'proposed' ? 'prop_' : '';
            const fuel = document.getElementById(prefix + 'fuelType')?.value;
            let pci = 38.5; // MJ/kg ou MJ/m¬≥ dependendo do combust√≠vel
            switch(fuel) {
                case 'natural-gas': pci = 38.5; break; // MJ/m¬≥
                case 'biomethane': pci = 38.5; break; // id√™ntico ao g√°s natural
                case 'lpg': pci = 46.0; break; // MJ/kg
                case 'oil': pci = 42.0; break; // MJ/kg
                case 'electric': pci = 3.6; break; // 1 kWh = 3,6 MJ
                case 'hydrogen': pci = 120.0; break; // MJ/kg (33,3 kWh/kg)
                case 'coal': pci = 24.0; break; // MJ/kg aproximado
            }
            const el = document.getElementById(prefix + 'calorificValue');
            if(el) el.value = pci;
        }
        
        // --- MENU 7: SIMULA√á√ÉO T√âCNICA ---
        function runFullSimulation() {
            if(!appData.furnace.perf || !appData.proposed.perf) return alert("Simule ambos os fornos primeiro (Menus 4 e 5).");
            
            document.getElementById('full-sim-results').classList.remove('hidden');
            
            const profile = appData.loadProfile;
            const effCurr = appData.furnace.perf.efficiency / 100 || 0.6; // Fallback
            const effProp = appData.proposed.perf.efficiency / 100 || 0.7;
            
            // Charts
            let hSums = new Array(24).fill(0);
            profile.forEach((v,i) => hSums[i%24] += v);
            let hAvg = hSums.map(v => v/365); 
            let hCurr = hAvg.map(v => v / effCurr);
            let hProp = hAvg.map(v => v / effProp);
            createChart('compChartDaily', 'line', Array.from({length:24},(_,i)=>i+'h'), hCurr, 'Forno Atual (Input kW)', '#f44336', hProp, 'Forno Proposto (Input kW)', '#4CAF50');
            
            let mSums = new Array(12).fill(0);
            let mDays = [31,28,31,30,31,30,31,31,30,31,30,31];
            let mIdx=0, hCount=0;
            profile.forEach(v => { mSums[mIdx]+=v; hCount++; if(hCount>=mDays[mIdx]*24) { hCount=0; mIdx++; if(mIdx>11) mIdx=11; } });
            let mCurr = mSums.map(v => (v/effCurr)/1000);
            let mProp = mSums.map(v => (v/effProp)/1000);
            createChart('compChartMonthly', 'bar', ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], mCurr, 'Atual (MWh)', '#f44336', mProp, 'Proposto (MWh)', '#4CAF50');
            
            let totalLoad = profile.reduce((a,b)=>a+b,0)/1000; 
            let totalCurr = totalLoad / effCurr;
            let totalProp = totalLoad / effProp;
            createChart('compChartYearly', 'bar', ['Consumo Anual'], [totalCurr], 'Atual (MWh)', '#f44336', [totalProp], 'Proposto (MWh)', '#4CAF50');

            // Technical Table
            const pCurr = getFuelPricePerKWh(appData.furnace.data.fuelType || 'natural-gas');
            const pProp = getFuelPricePerKWh(appData.proposed.data.fuelType || 'natural-gas');
            
            const costCurr = totalCurr * 1000 * pCurr; 
            const costProp = totalProp * 1000 * pProp;
            
            let h = `<table class="comp-table">
                <thead><tr><th>M√©trica</th><th>Forno Atual</th><th>Forno Proposto</th><th>Diferen√ßa</th></tr></thead>
                <tbody>
                    <tr><td>Consumo Anual (MWh)</td><td>${totalCurr.toFixed(1)}</td><td>${totalProp.toFixed(1)}</td><td class="comp-diff-pos">-${(totalCurr-totalProp).toFixed(1)}</td></tr>
                    <tr><td>Custo Anual (‚Ç¨)</td><td>${costCurr.toLocaleString()}</td><td>${costProp.toLocaleString()}</td><td class="comp-diff-pos">-${(costCurr-costProp).toLocaleString()}</td></tr>
                    <tr><td>M√©dia Di√°ria (kWh)</td><td>${(totalCurr*1000/365).toFixed(1)}</td><td>${(totalProp*1000/365).toFixed(1)}</td><td></td></tr>
                    <tr><td>M√©dia Mensal (MWh)</td><td>${(totalCurr/12).toFixed(1)}</td><td>${(totalProp/12).toFixed(1)}</td><td></td></tr>
                </tbody>
            </table>`;
            document.getElementById('technicalTableContainer').innerHTML = h;
            
            appData.simResults = { savings: costCurr - costProp, capex: appData.budget.total || 25000 };
            updateMenuUI();
        }

        // --- MENU 8: AN√ÅLISE FINANCEIRA ---
        function generateFinancialTable() {
            if(!appData.simResults) return alert("Execute a simula√ß√£o t√©cnica no Menu 7 primeiro.");
            
            document.getElementById('financial-results').classList.remove('hidden');
            
            const sav = appData.simResults.savings;
            const inv = appData.simResults.capex;
            const payback = sav > 0 ? inv/sav : 0;
            
            document.getElementById('fin-savings').innerText = "‚Ç¨ " + sav.toLocaleString();
            document.getElementById('fin-capex').innerText = "‚Ç¨ " + inv.toLocaleString();
            document.getElementById('fin-payback').innerText = payback.toFixed(1);
            
            let h = '<table><thead><tr><th>Ano</th><th>Fluxo Caixa</th><th>Acumulado</th></tr></thead><tbody>';
            let acc = -inv;
            for(let i=0; i<=10; i++) {
                if(i>0) acc+=sav;
                h+=`<tr><td>${i}</td><td>${i===0?-inv:sav.toFixed(0)}</td><td style="color:${acc>0?'green':'red'}">${acc.toFixed(0)}</td></tr>`;
            }
            h+='</tbody></table>';
            document.getElementById('financialTableContainer8').innerHTML = h;
        }

        function exportToJSON(){/*...*/} function importFromJSON(){/*...*/}
        function prepareComparison(){ alert("Vers√£o PRO"); }
        window.generatePDFReport = function(){ alert("PDF"); }
        // Gr√°fico de evolu√ß√£o hist√≥rica e proje√ß√£o futura dos pre√ßos dos combust√≠veis
        function renderTrendChart() {
            const ctx = document.getElementById('chartTrends').getContext('2d');
            // Construir vetor de anos de 2015 a 2035
            const years = [];
            for(let y = 2015; y <= 2035; y++) years.push(y.toString());

            // Valores base hist√≥ricos para Portugal (‚Ç¨/kWh) extra√≠dos de fontes oficiais
            // Eletricidade (pre√ßos dom√©sticos sem taxas) ‚Äì tabela Countryeconomy (2015‚Äë2025)
            const elecBase = {
                2015: 0.1150,
                2016: 0.1193,
                2017: 0.1268,
                2018: 0.1248,
                2019: 0.1252,
                2020: 0.1186,
                2021: 0.1318,
                2022: 0.1540,
                2023: 0.1600,
                2024: 0.1580,
                2025: 0.1590
            };
            const elec = [];
            years.forEach((y,i) => {
                const yr = parseInt(y);
                if(elecBase[yr] !== undefined) elec.push(elecBase[yr]);
                else {
                    // Proje√ß√£o: crescimento anual de 2% ap√≥s 2025
                    const last = elec[elec.length-1];
                    elec.push(parseFloat((last * 1.02).toFixed(4)));
                }
            });

            // G√°s natural ‚Äì pre√ßos regulamentados Escal√£o¬†2 (TudoLuzeG√°s) 2017‚Äë2026
            const gasBase = {
                2015: 0.0580,
                2016: 0.0550,
                2017: 0.0547,
                2018: 0.0544,
                2019: 0.0528,
                2020: 0.0493,
                2021: 0.0486,
                2022: 0.0544,
                2023: 0.0559,
                2024: 0.0598,
                2025: 0.0601
            };
            const gas = [];
            years.forEach(y => {
                const yr = parseInt(y);
                if(gasBase[yr] !== undefined) gas.push(gasBase[yr]);
                else {
                    // Proje√ß√£o: crescimento anual de 1,5% ap√≥s 2025
                    const last = gas[gas.length-1];
                    gas.push(parseFloat((last * 1.015).toFixed(4)));
                }
            });

            // Biometano ‚Äì custo do plano LNEG (~62¬†‚Ç¨/MWh ‚âà0,062¬†‚Ç¨/kWh). Assumimos estabilidade no curto prazo.
            const bio = [];
            years.forEach(() => bio.push(0.062));

            // GLP ‚Äì pre√ßos m√©dios (ERSE 2024‚Äë2025) convertidos para ‚Ç¨/kWh (PCI 12,8¬†kWh/kg). Proje√ß√£o 2%/ano
            const lpgBase = {
                2015: 0.050,
                2016: 0.052,
                2017: 0.054,
                2018: 0.055,
                2019: 0.058,
                2020: 0.060,
                2021: 0.065,
                2022: 0.070,
                2023: 0.075,
                2024: 0.080,
                2025: 0.090
            };
            const lpg = [];
            years.forEach(y => {
                const yr = parseInt(y);
                if(lpgBase[yr] !== undefined) lpg.push(lpgBase[yr]);
                else {
                    const last = lpg[lpg.length-1];
                    lpg.push(parseFloat((last * 1.02).toFixed(4)));
                }
            });

            // √ìleo combust√≠vel ‚Äì valores aproximados para 2015‚Äë2025; proje√ß√£o 2%/ano
            const oilBase = {
                2015: 0.060,
                2016: 0.065,
                2017: 0.070,
                2018: 0.075,
                2019: 0.080,
                2020: 0.075,
                2021: 0.078,
                2022: 0.079,
                2023: 0.081,
                2024: 0.082,
                2025: 0.082
            };
            const oil = [];
            years.forEach(y => {
                const yr = parseInt(y);
                if(oilBase[yr] !== undefined) oil.push(oilBase[yr]);
                else {
                    const last = oil[oil.length-1];
                    oil.push(parseFloat((last * 1.02).toFixed(4)));
                }
            });

            // Hidrog√©nio verde ‚Äì valores estimados (‚Ç¨/kWh) decrescentes devido a economia de escala
            const h2Base = {
                2015: 0.200,
                2016: 0.200,
                2017: 0.195,
                2018: 0.190,
                2019: 0.185,
                2020: 0.180,
                2021: 0.175,
                2022: 0.175,
                2023: 0.180,
                2024: 0.180,
                2025: 0.180
            };
            const h2 = [];
            years.forEach(y => {
                const yr = parseInt(y);
                if(h2Base[yr] !== undefined) h2.push(h2Base[yr]);
                else {
                    // Ap√≥s 2025, decr√©scimo de 5% at√© atingir 0,12¬†‚Ç¨/kWh
                    const last = h2[h2.length-1];
                    const next = last * 0.95;
                    h2.push(parseFloat((next < 0.12 ? 0.12 : next).toFixed(4)));
                }
            });

            // Construir gr√°fico com m√∫ltiplas s√©ries
            if(window.trendChart) window.trendChart.destroy();
            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        { label: 'Eletricidade', data: elec, borderColor: '#667eea', backgroundColor: 'transparent', tension: 0.2 },
                        { label: 'G√°s Natural', data: gas, borderColor: '#ff9800', backgroundColor: 'transparent', tension: 0.2 },
                        { label: 'Biometano', data: bio, borderColor: '#2196F3', backgroundColor: 'transparent', tension: 0.2 },
                        { label: 'GLP', data: lpg, borderColor: '#9c27b0', backgroundColor: 'transparent', tension: 0.2 },
                        { label: '√ìleo', data: oil, borderColor: '#795548', backgroundColor: 'transparent', tension: 0.2 },
                        { label: 'Hidrog√©nio', data: h2, borderColor: '#4CAF50', backgroundColor: 'transparent', tension: 0.2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Pre√ßo (‚Ç¨/kWh)' },
                            min: 0,
                            grid: { color: '#eee' }
                        },
                        x: {
                            title: { display: true, text: 'Ano' },
                            grid: { color: '#fafafa' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
